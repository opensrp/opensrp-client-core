package org.smartregister.service;

import static org.mockito.ArgumentMatchers.anyString;
import static org.mockito.Mockito.spy;
import static org.smartregister.domain.ResponseStatus.success;
import static org.smartregister.service.DocumentConfigurationService.IDENTIFIERS;
import static org.smartregister.service.DocumentConfigurationService.MANIFEST_FORMS_VERSION;

import com.google.gson.Gson;
import com.google.gson.GsonBuilder;
import com.google.gson.reflect.TypeToken;

import org.json.JSONException;
import org.json.JSONObject;
import org.junit.After;
import org.junit.Assert;
import org.junit.Before;
import org.junit.Test;
import org.mockito.Mock;
import org.mockito.Mockito;
import org.robolectric.annotation.Config;
import org.smartregister.BaseRobolectricUnitTest;
import org.smartregister.CoreLibrary;
import org.smartregister.DristhiConfiguration;
import org.smartregister.domain.ClientForm;
import org.smartregister.domain.Manifest;
import org.smartregister.domain.Response;
import org.smartregister.dto.ClientFormResponse;
import org.smartregister.dto.ManifestDTO;
import org.smartregister.repository.ClientFormRepository;
import org.smartregister.repository.ManifestRepository;
import org.smartregister.shadows.ShadowUtils;

import java.util.List;

/**
 * Created by cozej4 on 2020-04-16.
 *
 * @author cozej4 https://github.com/cozej4
 */
public class DocumentConfigurationServiceTest extends BaseRobolectricUnitTest {

    @Mock
    private HTTPAgent httpAgent;

    @Mock
    private ManifestRepository manifestRepository;

    @Mock
    private ClientFormRepository clientFormRepository;

    @Mock
    private DristhiConfiguration configuration;


    private DocumentConfigurationService documentConfigurationService;


    @Before
    public void setUp() {
        documentConfigurationService = new DocumentConfigurationService(httpAgent, manifestRepository, clientFormRepository, configuration);
        Mockito.when(configuration.dristhiBaseURL()).thenReturn("http://opensrp_base_url");
    }

    @Test
    public void convertManifestDTOToManifest() throws JSONException {
        String manifestDTOJson = "{\"json\":\"{\\\"forms_version\\\":\\\"0.0.1\\\",\\\"identifiers\\\":[\\\"anc/member_registration.json\\\",\\\"anc/pregnancy_outcome.json\\\"]}\",\"appId\":\"org.smartregister.chw\",\"appVersion\":\"0.0.1\",\"id\":1}";
        ManifestDTO manifestDTO = new Gson().fromJson(manifestDTOJson, ManifestDTO.class);
        Manifest manifest;
        manifest = documentConfigurationService.convertManifestDTOToManifest(manifestDTO);
        Assert.assertEquals(manifest.getAppVersion(), manifestDTO.getAppVersion());
        Assert.assertEquals(manifest.getCreatedAt(), manifestDTO.getCreatedAt());

        JSONObject json = new JSONObject(manifestDTO.getJson());
        Assert.assertEquals(manifest.getFormVersion(), json.getString(MANIFEST_FORMS_VERSION));
        Assert.assertEquals(manifest.getIdentifiers(), new Gson().fromJson(json.getString(IDENTIFIERS), new TypeToken<List<String>>() {
        }.getType()));
    }

    @Test
    public void convertClientFormResponseToClientForm() throws JSONException {
        String clientFormResponseJson = "{\"clientForm\":{\"id\":3,\"json\":\"\\\"{\\\\n  \\\\\\\"form\\\\\\\": \\\\\\\"ANC Referral\\\\\\\",\\\\n  \\\\\\\"count\\\\\\\": \\\\\\\"1\\\\\\\",\\\\n  \\\\\\\"encounter_type\\\\\\\": \\\\\\\"ANC Referral\\\\\\\",\\\\n  \\\\\\\"entity_id\\\\\\\": \\\\\\\"\\\\\\\",\\\\n  \\\\\\\"relational_id\\\\\\\": \\\\\\\"\\\\\\\",\\\\n  \\\\\\\"rules_file\\\\\\\": \\\\\\\"rule/general_neat_referral_form_rules.yml\\\\\\\",\\\\n  \\\\\\\"metadata\\\\\\\": {\\\\n    \\\\\\\"start\\\\\\\": {\\\\n      \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\",\\\\n      \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"concept\\\\\\\",\\\\n      \\\\\\\"openmrs_data_type\\\\\\\": \\\\\\\"start\\\\\\\",\\\\n      \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"163137AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\"\\\\n    },\\\\n    \\\\\\\"end\\\\\\\": {\\\\n      \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\",\\\\n      \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"concept\\\\\\\",\\\\n      \\\\\\\"openmrs_data_type\\\\\\\": \\\\\\\"end\\\\\\\",\\\\n      \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"163138AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\"\\\\n    },\\\\n    \\\\\\\"today\\\\\\\": {\\\\n      \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\",\\\\n      \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"encounter\\\\\\\",\\\\n      \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"encounter_date\\\\\\\"\\\\n    },\\\\n    \\\\\\\"deviceid\\\\\\\": {\\\\n      \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\",\\\\n      \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"concept\\\\\\\",\\\\n      \\\\\\\"openmrs_data_type\\\\\\\": \\\\\\\"deviceid\\\\\\\",\\\\n      \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"163149AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\"\\\\n    },\\\\n    \\\\\\\"subscriberid\\\\\\\": {\\\\n      \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\",\\\\n      \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"concept\\\\\\\",\\\\n      \\\\\\\"openmrs_data_type\\\\\\\": \\\\\\\"subscriberid\\\\\\\",\\\\n      \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"163150AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\"\\\\n    },\\\\n    \\\\\\\"simserial\\\\\\\": {\\\\n      \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\",\\\\n      \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"concept\\\\\\\",\\\\n      \\\\\\\"openmrs_data_type\\\\\\\": \\\\\\\"simserial\\\\\\\",\\\\n      \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"163151AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\"\\\\n    },\\\\n    \\\\\\\"phonenumber\\\\\\\": {\\\\n      \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\",\\\\n      \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"concept\\\\\\\",\\\\n      \\\\\\\"openmrs_data_type\\\\\\\": \\\\\\\"phonenumber\\\\\\\",\\\\n      \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"163152AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\"\\\\n    },\\\\n    \\\\\\\"encounter_location\\\\\\\": \\\\\\\"\\\\\\\",\\\\n    \\\\\\\"look_up\\\\\\\": {\\\\n      \\\\\\\"entity_id\\\\\\\": \\\\\\\"\\\\\\\",\\\\n      \\\\\\\"value\\\\\\\": \\\\\\\"\\\\\\\"\\\\n    }\\\\n  },\\\\n  \\\\\\\"steps\\\\\\\": [\\\\n    {\\\\n      \\\\\\\"title\\\\\\\": \\\\\\\"ANC referral form\\\\\\\",\\\\n      \\\\\\\"fields\\\\\\\": [\\\\n        {\\\\n          \\\\\\\"name\\\\\\\": \\\\\\\"chw_referral_service\\\\\\\",\\\\n          \\\\\\\"type\\\\\\\": \\\\\\\"invisible\\\\\\\",\\\\n          \\\\\\\"properties\\\\\\\": {\\\\n            \\\\\\\"text\\\\\\\": \\\\\\\"Choose referral service\\\\\\\"\\\\n          },\\\\n          \\\\\\\"meta_data\\\\\\\": {\\\\n            \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"concept\\\\\\\",\\\\n            \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"09978\\\\\\\",\\\\n            \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n          },\\\\n          \\\\\\\"options\\\\\\\": [],\\\\n          \\\\\\\"required_status\\\\\\\": \\\\\\\"yes:Please specify referral service\\\\\\\"\\\\n        },\\\\n        {\\\\n          \\\\\\\"name\\\\\\\": \\\\\\\"problem\\\\\\\",\\\\n          \\\\\\\"type\\\\\\\": \\\\\\\"multi_choice_checkbox\\\\\\\",\\\\n          \\\\\\\"properties\\\\\\\": {\\\\n            \\\\\\\"text\\\\\\\": \\\\\\\"Pick condition/problem associated with the client.\\\\\\\"\\\\n          },\\\\n          \\\\\\\"meta_data\\\\\\\": {\\\\n            \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\",\\\\n            \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"concept\\\\\\\",\\\\n            \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"163182AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\"\\\\n          },\\\\n          \\\\\\\"options\\\\\\\": [\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Vaginal_bleeding\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Vaginal bleeding\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"147232AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Discoloured_or_watery_liquid_vaginal_discharge_with_a_bad_smell\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Discoloured or watery, liquid vaginal discharge with a bad smell\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"123396AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"High_blood_pressure\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"High blood pressure\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"113088AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Severe_abdominal_pain\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Severe abdominal pain\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"165271AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Severe_anaemia\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Severe anaemia\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"162044AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Convulsions\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Convulsions\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"113054AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"No_movement_unusual_movement_for_a_child_in_the_womb\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"No movement / unusual movement for a child in the womb\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"113377AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Pregnancy_pains_before_9_months\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Pregnancy pains before 9 months\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"153316AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Early_age_pregnancy_below_18_years\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Early age pregnancy (below 18 years)\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"163119AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"A_severe_headache_dizziness\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"A severe headache / dizziness\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"139081AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Swelling_of_the_face_andor_hands\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Swelling of the face and/or hands\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"460AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Fever\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Fever\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"140238AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Shivering_trembling\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Shivering/trembling\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"158359AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Nausea_and_Vomiting\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Nausea and vomiting\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"133473AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Water_sack_broke_before_contractions\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Water sack broke before contractions\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"129211AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Cord_prolapse\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Cord prolapse\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"128419AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"HIV_care_and_support_services\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"HIV care and support services\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"159811AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Family_planning_services\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Family planning services\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"5271AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"PMTCT_for_mothers\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"PMTCT for mothers\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"160538AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Fistula\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Fistula\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"160854AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Difficultly_breathing\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Difficultly breathing\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"142373AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Breast_engorgement\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Breast engorgement\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"118620AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Blurred_vision\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Blurred vision\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"147104AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Perineum_tear\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Perineum tear\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"136938AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Pregnancy_confirmation\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Pregnancy confirmation\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"152305AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Other_symptoms\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Other symptoms\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"5622AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            }\\\\n          ],\\\\n          \\\\\\\"required_status\\\\\\\": \\\\\\\"yes:Please specify reason for ANC referral\\\\\\\"\\\\n        },\\\\n        {\\\\n          \\\\\\\"name\\\\\\\": \\\\\\\"problem_other\\\\\\\",\\\\n          \\\\\\\"type\\\\\\\": \\\\\\\"text_input_edit_text\\\\\\\",\\\\n          \\\\\\\"meta_data\\\\\\\": {\\\\n            \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"concept\\\\\\\",\\\\n            \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"160632AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n            \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"163182AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\"\\\\n          },\\\\n          \\\\\\\"properties\\\\\\\": {\\\\n            \\\\\\\"hint\\\\\\\": \\\\\\\"Other symptoms\\\\\\\",\\\\n            \\\\\\\"type\\\\\\\": \\\\\\\"name\\\\\\\"\\\\n          },\\\\n          \\\\\\\"required_status\\\\\\\": \\\\\\\"true:Please specify other symptoms\\\\\\\",\\\\n          \\\\\\\"subjects\\\\\\\": \\\\\\\"problem:map\\\\\\\"\\\\n        },\\\\n        {\\\\n          \\\\\\\"name\\\\\\\": \\\\\\\"service_before_referral\\\\\\\",\\\\n          \\\\\\\"meta_data\\\\\\\": {\\\\n            \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\",\\\\n            \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"concept\\\\\\\",\\\\n            \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"164378AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\"\\\\n          },\\\\n          \\\\\\\"type\\\\\\\": \\\\\\\"multi_choice_checkbox\\\\\\\",\\\\n          \\\\\\\"is_problem\\\\\\\": false,\\\\n          \\\\\\\"properties\\\\\\\": {\\\\n            \\\\\\\"text\\\\\\\": \\\\\\\"Pre-referral management given.\\\\\\\"\\\\n          },\\\\n          \\\\\\\"options\\\\\\\": [\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"ORS\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"ORS\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"351AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Panadol\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Panadol\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"70116AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Other_treatment\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Other treatment\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"5622AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"None\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"None\\\\\\\",\\\\n              \\\\\\\"is_exclusive\\\\\\\": true,\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"164369AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            }\\\\n          ],\\\\n          \\\\\\\"required_status\\\\\\\": \\\\\\\"Pre-referral management field is required\\\\\\\"\\\\n        },\\\\n        {\\\\n          \\\\\\\"name\\\\\\\": \\\\\\\"service_before_referral_other\\\\\\\",\\\\n          \\\\\\\"type\\\\\\\": \\\\\\\"text_input_edit_text\\\\\\\",\\\\n          \\\\\\\"meta_data\\\\\\\": {\\\\n            \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"concept\\\\\\\",\\\\n            \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"160632AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n            \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"164378AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\"\\\\n          },\\\\n          \\\\\\\"properties\\\\\\\": {\\\\n            \\\\\\\"hint\\\\\\\": \\\\\\\"Other Treatment\\\\\\\",\\\\n            \\\\\\\"type\\\\\\\": \\\\\\\"name\\\\\\\"\\\\n          },\\\\n          \\\\\\\"required_status\\\\\\\": \\\\\\\"true:Please specify other treatment given\\\\\\\",\\\\n          \\\\\\\"subjects\\\\\\\": \\\\\\\"service_before_referral:map\\\\\\\"\\\\n        },\\\\n        {\\\\n          \\\\\\\"name\\\\\\\": \\\\\\\"chw_referral_hf\\\\\\\",\\\\n          \\\\\\\"type\\\\\\\": \\\\\\\"spinner\\\\\\\",\\\\n          \\\\\\\"meta_data\\\\\\\": {\\\\n            \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"concept\\\\\\\",\\\\n            \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"chw_referral_hf\\\\\\\",\\\\n            \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n          },\\\\n          \\\\\\\"properties\\\\\\\": {\\\\n            \\\\\\\"text\\\\\\\": \\\\\\\"Choose referral facility\\\\\\\",\\\\n            \\\\\\\"searchable\\\\\\\": \\\\\\\"Choose referral facility\\\\\\\"\\\\n          },\\\\n          \\\\\\\"options\\\\\\\": [],\\\\n          \\\\\\\"required_status\\\\\\\": \\\\\\\"yes:Please specify referral facility\\\\\\\"\\\\n        },\\\\n        {\\\\n          \\\\\\\"name\\\\\\\": \\\\\\\"referral_appointment_date\\\\\\\",\\\\n          \\\\\\\"type\\\\\\\": \\\\\\\"datetime_picker\\\\\\\",\\\\n          \\\\\\\"properties\\\\\\\": {\\\\n            \\\\\\\"hint\\\\\\\": \\\\\\\"Please select the appointment date\\\\\\\",\\\\n            \\\\\\\"type\\\\\\\": \\\\\\\"date_picker\\\\\\\",\\\\n            \\\\\\\"display_format\\\\\\\": \\\\\\\"dd/MM/yyyy\\\\\\\"\\\\n          },\\\\n          \\\\\\\"meta_data\\\\\\\": {\\\\n            \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"concept\\\\\\\",\\\\n            \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"referral_appointment_date\\\\\\\",\\\\n            \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n          },\\\\n          \\\\\\\"required_status\\\\\\\": \\\\\\\"true:Please specify the appointment date\\\\\\\"\\\\n        },\\\\n        {\\\\n          \\\\\\\"name\\\\\\\": \\\\\\\"referral_date\\\\\\\",\\\\n          \\\\\\\"meta_data\\\\\\\": {\\\\n            \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\",\\\\n            \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"concept\\\\\\\",\\\\n            \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"163181AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\"\\\\n          },\\\\n          \\\\\\\"type\\\\\\\": \\\\\\\"hidden\\\\\\\"\\\\n        },\\\\n        {\\\\n          \\\\\\\"name\\\\\\\": \\\\\\\"referral_time\\\\\\\",\\\\n          \\\\\\\"meta_data\\\\\\\": {\\\\n            \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\",\\\\n            \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"concept\\\\\\\",\\\\n            \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"referral_time\\\\\\\"\\\\n          },\\\\n          \\\\\\\"type\\\\\\\": \\\\\\\"hidden\\\\\\\"\\\\n        },\\\\n        {\\\\n          \\\\\\\"name\\\\\\\": \\\\\\\"referral_type\\\\\\\",\\\\n          \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\",\\\\n          \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"concept\\\\\\\",\\\\n          \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"referral_type\\\\\\\",\\\\n          \\\\\\\"type\\\\\\\": \\\\\\\"hidden\\\\\\\"\\\\n        },\\\\n        {\\\\n          \\\\\\\"name\\\\\\\": \\\\\\\"referral_status\\\\\\\",\\\\n          \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\",\\\\n          \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"concept\\\\\\\",\\\\n          \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"referral_status\\\\\\\",\\\\n          \\\\\\\"type\\\\\\\": \\\\\\\"hidden\\\\\\\"\\\\n        }\\\\n      ]\\\\n    }\\\\n  ]\\\\n}\\\"\",\"createdAt\":\"Apr 22, 2020, 7:00:40 PM\"},\"clientFormMetadata\":{\"id\":3,\"identifier\":\"referrals/anc_referral_form\",\"version\":\"0.0.2\",\"label\":\"ANC Referral form\",\"module\":\"ANC\",\"createdAt\":\"Apr 22, 2020, 7:00:40 PM\"}}";
        Gson gson = new GsonBuilder().setDateFormat("MMM dd, yyyy, hh:mm:ss aaa").create();
        ClientFormResponse clientFormResponse = gson.fromJson(clientFormResponseJson, ClientFormResponse.class);
        ClientForm clientForm = documentConfigurationService.convertClientFormResponseToClientForm(clientFormResponse);
        Assert.assertEquals(clientForm.getIdentifier(), clientFormResponse.getClientFormMetadata().getIdentifier());
        Assert.assertEquals(clientForm.getCreatedAt(), clientFormResponse.getClientFormMetadata().getCreatedAt());

        JSONObject formJson = null;
        formJson = new JSONObject(clientForm.getJson());

        Assert.assertNotNull(formJson);
        Assert.assertEquals(clientForm.getVersion(), clientFormResponse.getClientFormMetadata().getVersion());
    }

    @Test
    @Config(shadows = {ShadowUtils.class})
    public void fetchManifestShouldSaveFetchedManifestWhenNoActiveManifestIsAvailable() throws Exception {
        String jsonObject = "{\"identifier\":\"12\",\"json\":\"{\\\"forms_version\\\":\\\"0.0.8\\\",\\\"identifiers\\\":[\\\"referrals/anc_referral_form\\\",\\\"referrals/anc_referral_form-sw\\\",\\\"referrals/child_gbv_referral_form\\\",\\\"referrals/child_gbv_referral_form-sw\\\",\\\"referrals/child_referral_form\\\",\\\"referrals/child_referral_form-sw\\\",\\\"referrals/gbv_referral_form\\\",\\\"referrals/gbv_referral_form-sw\\\",\\\"referrals/hiv_referral_form\\\",\\\"referrals/hiv_referral_form-sw\\\",\\\"referrals/pnc_referral_form\\\",\\\"referrals/pnc_referral_form-sw\\\",\\\"referrals/tb_referral_form\\\",\\\"referrals/tb_referral_form-sw\\\"]}\",\"appId\":\"org.smartregister.chw\",\"appVersion\":\"0.2.0\",\"createdAt\":\"2020-04-23T16:28:19.879+03:00\",\"updatedAt\":\"2020-04-23T16:28:19.879+03:00\"}";
        Mockito.when(httpAgent.fetch(anyString())).thenReturn(
                new Response<String>(
                        success,
                        jsonObject));
        documentConfigurationService = spy(documentConfigurationService);
        Mockito.doNothing().when(manifestRepository).addOrUpdate(Mockito.any(Manifest.class));
        Mockito.doNothing().when(documentConfigurationService).syncClientForms(Mockito.any());
        documentConfigurationService.fetchManifest();

        Mockito.verify(manifestRepository).addOrUpdate(Mockito.any(Manifest.class));
        Mockito.verify(documentConfigurationService).saveManifestVersion("12");
        Mockito.verify(documentConfigurationService).saveFormsVersion("0.0.8");
    }

    @Test
    @Config(shadows = {ShadowUtils.class})
    public void fetchManifestShouldSaveFetchedManifestAndDeactivatePreviousActiveManifestWhenActiveManifestIsAvailable() throws Exception {
        String jsonObject = "{\"identifier\":\"12\",\"json\":\"{\\\"forms_version\\\":\\\"0.0.8\\\",\\\"identifiers\\\":[\\\"referrals/anc_referral_form\\\",\\\"referrals/anc_referral_form-sw\\\",\\\"referrals/child_gbv_referral_form\\\",\\\"referrals/child_gbv_referral_form-sw\\\",\\\"referrals/child_referral_form\\\",\\\"referrals/child_referral_form-sw\\\",\\\"referrals/gbv_referral_form\\\",\\\"referrals/gbv_referral_form-sw\\\",\\\"referrals/hiv_referral_form\\\",\\\"referrals/hiv_referral_form-sw\\\",\\\"referrals/pnc_referral_form\\\",\\\"referrals/pnc_referral_form-sw\\\",\\\"referrals/tb_referral_form\\\",\\\"referrals/tb_referral_form-sw\\\"]}\",\"appId\":\"org.smartregister.chw\",\"appVersion\":\"0.2.0\",\"createdAt\":\"2020-04-23T16:28:19.879+03:00\",\"updatedAt\":\"2020-04-23T16:28:19.879+03:00\"}";
        Mockito.when(httpAgent.fetch(anyString())).thenReturn(
                new Response<String>(
                        success,
                        jsonObject));

        Manifest manifest = new Manifest();
        manifest.setFormVersion("0.0.1");
        Mockito.doReturn(manifest).when(manifestRepository).getActiveManifest();
        Mockito.doNothing().when(manifestRepository).addOrUpdate(Mockito.any(Manifest.class));
        documentConfigurationService = spy(documentConfigurationService);
        Mockito.doNothing().when(documentConfigurationService).syncClientForms(Mockito.any());
        documentConfigurationService.fetchManifest();

        Mockito.verify(manifestRepository, Mockito.times(2)).addOrUpdate(Mockito.any(Manifest.class));
        Mockito.verify(documentConfigurationService).saveManifestVersion("12");
        Mockito.verify(documentConfigurationService).saveFormsVersion("0.0.8");
    }

    @Test
    public void fetchClientForm() {
        String manifestJson = "{\"identifiers\":[\"referrals/anc_referral_form\"],\"formVersion\":\"0.0.8\",\"appVersion\":\"0.2.0\",\"createdAt\":\"2020-04-23T16:28:19.879+03:00\"}";
        Gson gson = new GsonBuilder().setDateFormat("MMM dd, yyyy, hh:mm:ss aaa").create();
        Manifest activeManifest = gson.fromJson(manifestJson, Manifest.class);

        String jsonObject = "{\"clientForm\":{\"id\":3,\"json\":\"\\\"{\\\\n  \\\\\\\"form\\\\\\\": \\\\\\\"ANC Referral\\\\\\\",\\\\n  \\\\\\\"count\\\\\\\": \\\\\\\"1\\\\\\\",\\\\n  \\\\\\\"encounter_type\\\\\\\": \\\\\\\"ANC Referral\\\\\\\",\\\\n  \\\\\\\"entity_id\\\\\\\": \\\\\\\"\\\\\\\",\\\\n  \\\\\\\"relational_id\\\\\\\": \\\\\\\"\\\\\\\",\\\\n  \\\\\\\"rules_file\\\\\\\": \\\\\\\"rule/general_neat_referral_form_rules.yml\\\\\\\",\\\\n  \\\\\\\"metadata\\\\\\\": {\\\\n    \\\\\\\"start\\\\\\\": {\\\\n      \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\",\\\\n      \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"concept\\\\\\\",\\\\n      \\\\\\\"openmrs_data_type\\\\\\\": \\\\\\\"start\\\\\\\",\\\\n      \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"163137AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\"\\\\n    },\\\\n    \\\\\\\"end\\\\\\\": {\\\\n      \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\",\\\\n      \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"concept\\\\\\\",\\\\n      \\\\\\\"openmrs_data_type\\\\\\\": \\\\\\\"end\\\\\\\",\\\\n      \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"163138AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\"\\\\n    },\\\\n    \\\\\\\"today\\\\\\\": {\\\\n      \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\",\\\\n      \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"encounter\\\\\\\",\\\\n      \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"encounter_date\\\\\\\"\\\\n    },\\\\n    \\\\\\\"deviceid\\\\\\\": {\\\\n      \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\",\\\\n      \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"concept\\\\\\\",\\\\n      \\\\\\\"openmrs_data_type\\\\\\\": \\\\\\\"deviceid\\\\\\\",\\\\n      \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"163149AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\"\\\\n    },\\\\n    \\\\\\\"subscriberid\\\\\\\": {\\\\n      \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\",\\\\n      \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"concept\\\\\\\",\\\\n      \\\\\\\"openmrs_data_type\\\\\\\": \\\\\\\"subscriberid\\\\\\\",\\\\n      \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"163150AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\"\\\\n    },\\\\n    \\\\\\\"simserial\\\\\\\": {\\\\n      \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\",\\\\n      \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"concept\\\\\\\",\\\\n      \\\\\\\"openmrs_data_type\\\\\\\": \\\\\\\"simserial\\\\\\\",\\\\n      \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"163151AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\"\\\\n    },\\\\n    \\\\\\\"phonenumber\\\\\\\": {\\\\n      \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\",\\\\n      \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"concept\\\\\\\",\\\\n      \\\\\\\"openmrs_data_type\\\\\\\": \\\\\\\"phonenumber\\\\\\\",\\\\n      \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"163152AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\"\\\\n    },\\\\n    \\\\\\\"encounter_location\\\\\\\": \\\\\\\"\\\\\\\",\\\\n    \\\\\\\"look_up\\\\\\\": {\\\\n      \\\\\\\"entity_id\\\\\\\": \\\\\\\"\\\\\\\",\\\\n      \\\\\\\"value\\\\\\\": \\\\\\\"\\\\\\\"\\\\n    }\\\\n  },\\\\n  \\\\\\\"steps\\\\\\\": [\\\\n    {\\\\n      \\\\\\\"title\\\\\\\": \\\\\\\"ANC referral form\\\\\\\",\\\\n      \\\\\\\"fields\\\\\\\": [\\\\n        {\\\\n          \\\\\\\"name\\\\\\\": \\\\\\\"chw_referral_service\\\\\\\",\\\\n          \\\\\\\"type\\\\\\\": \\\\\\\"invisible\\\\\\\",\\\\n          \\\\\\\"properties\\\\\\\": {\\\\n            \\\\\\\"text\\\\\\\": \\\\\\\"Choose referral service\\\\\\\"\\\\n          },\\\\n          \\\\\\\"meta_data\\\\\\\": {\\\\n            \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"concept\\\\\\\",\\\\n            \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"09978\\\\\\\",\\\\n            \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n          },\\\\n          \\\\\\\"options\\\\\\\": [],\\\\n          \\\\\\\"required_status\\\\\\\": \\\\\\\"yes:Please specify referral service\\\\\\\"\\\\n        },\\\\n        {\\\\n          \\\\\\\"name\\\\\\\": \\\\\\\"problem\\\\\\\",\\\\n          \\\\\\\"type\\\\\\\": \\\\\\\"multi_choice_checkbox\\\\\\\",\\\\n          \\\\\\\"properties\\\\\\\": {\\\\n            \\\\\\\"text\\\\\\\": \\\\\\\"Pick condition/problem associated with the client.\\\\\\\"\\\\n          },\\\\n          \\\\\\\"meta_data\\\\\\\": {\\\\n            \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\",\\\\n            \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"concept\\\\\\\",\\\\n            \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"163182AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\"\\\\n          },\\\\n          \\\\\\\"options\\\\\\\": [\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Vaginal_bleeding\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Vaginal bleeding\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"147232AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Discoloured_or_watery_liquid_vaginal_discharge_with_a_bad_smell\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Discoloured or watery, liquid vaginal discharge with a bad smell\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"123396AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"High_blood_pressure\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"High blood pressure\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"113088AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Severe_abdominal_pain\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Severe abdominal pain\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"165271AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Severe_anaemia\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Severe anaemia\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"162044AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Convulsions\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Convulsions\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"113054AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"No_movement_unusual_movement_for_a_child_in_the_womb\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"No movement / unusual movement for a child in the womb\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"113377AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Pregnancy_pains_before_9_months\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Pregnancy pains before 9 months\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"153316AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Early_age_pregnancy_below_18_years\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Early age pregnancy (below 18 years)\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"163119AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"A_severe_headache_dizziness\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"A severe headache / dizziness\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"139081AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Swelling_of_the_face_andor_hands\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Swelling of the face and/or hands\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"460AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Fever\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Fever\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"140238AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Shivering_trembling\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Shivering/trembling\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"158359AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Nausea_and_Vomiting\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Nausea and vomiting\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"133473AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Water_sack_broke_before_contractions\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Water sack broke before contractions\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"129211AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Cord_prolapse\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Cord prolapse\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"128419AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"HIV_care_and_support_services\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"HIV care and support services\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"159811AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Family_planning_services\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Family planning services\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"5271AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"PMTCT_for_mothers\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"PMTCT for mothers\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"160538AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Fistula\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Fistula\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"160854AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Difficultly_breathing\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Difficultly breathing\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"142373AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Breast_engorgement\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Breast engorgement\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"118620AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Blurred_vision\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Blurred vision\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"147104AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Perineum_tear\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Perineum tear\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"136938AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Pregnancy_confirmation\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Pregnancy confirmation\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"152305AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Other_symptoms\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Other symptoms\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"5622AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            }\\\\n          ],\\\\n          \\\\\\\"required_status\\\\\\\": \\\\\\\"yes:Please specify reason for ANC referral\\\\\\\"\\\\n        },\\\\n        {\\\\n          \\\\\\\"name\\\\\\\": \\\\\\\"problem_other\\\\\\\",\\\\n          \\\\\\\"type\\\\\\\": \\\\\\\"text_input_edit_text\\\\\\\",\\\\n          \\\\\\\"meta_data\\\\\\\": {\\\\n            \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"concept\\\\\\\",\\\\n            \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"160632AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n            \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"163182AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\"\\\\n          },\\\\n          \\\\\\\"properties\\\\\\\": {\\\\n            \\\\\\\"hint\\\\\\\": \\\\\\\"Other symptoms\\\\\\\",\\\\n            \\\\\\\"type\\\\\\\": \\\\\\\"name\\\\\\\"\\\\n          },\\\\n          \\\\\\\"required_status\\\\\\\": \\\\\\\"true:Please specify other symptoms\\\\\\\",\\\\n          \\\\\\\"subjects\\\\\\\": \\\\\\\"problem:map\\\\\\\"\\\\n        },\\\\n        {\\\\n          \\\\\\\"name\\\\\\\": \\\\\\\"service_before_referral\\\\\\\",\\\\n          \\\\\\\"meta_data\\\\\\\": {\\\\n            \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\",\\\\n            \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"concept\\\\\\\",\\\\n            \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"164378AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\"\\\\n          },\\\\n          \\\\\\\"type\\\\\\\": \\\\\\\"multi_choice_checkbox\\\\\\\",\\\\n          \\\\\\\"is_problem\\\\\\\": false,\\\\n          \\\\\\\"properties\\\\\\\": {\\\\n            \\\\\\\"text\\\\\\\": \\\\\\\"Pre-referral management given.\\\\\\\"\\\\n          },\\\\n          \\\\\\\"options\\\\\\\": [\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"ORS\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"ORS\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"351AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Panadol\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Panadol\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"70116AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"Other_treatment\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"Other treatment\\\\\\\",\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"5622AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            },\\\\n            {\\\\n              \\\\\\\"name\\\\\\\": \\\\\\\"None\\\\\\\",\\\\n              \\\\\\\"text\\\\\\\": \\\\\\\"None\\\\\\\",\\\\n              \\\\\\\"is_exclusive\\\\\\\": true,\\\\n              \\\\\\\"meta_data\\\\\\\": {\\\\n                \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"164369AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n                \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n              }\\\\n            }\\\\n          ],\\\\n          \\\\\\\"required_status\\\\\\\": \\\\\\\"Pre-referral management field is required\\\\\\\"\\\\n        },\\\\n        {\\\\n          \\\\\\\"name\\\\\\\": \\\\\\\"service_before_referral_other\\\\\\\",\\\\n          \\\\\\\"type\\\\\\\": \\\\\\\"text_input_edit_text\\\\\\\",\\\\n          \\\\\\\"meta_data\\\\\\\": {\\\\n            \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"concept\\\\\\\",\\\\n            \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"160632AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\",\\\\n            \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"164378AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\"\\\\n          },\\\\n          \\\\\\\"properties\\\\\\\": {\\\\n            \\\\\\\"hint\\\\\\\": \\\\\\\"Other Treatment\\\\\\\",\\\\n            \\\\\\\"type\\\\\\\": \\\\\\\"name\\\\\\\"\\\\n          },\\\\n          \\\\\\\"required_status\\\\\\\": \\\\\\\"true:Please specify other treatment given\\\\\\\",\\\\n          \\\\\\\"subjects\\\\\\\": \\\\\\\"service_before_referral:map\\\\\\\"\\\\n        },\\\\n        {\\\\n          \\\\\\\"name\\\\\\\": \\\\\\\"chw_referral_hf\\\\\\\",\\\\n          \\\\\\\"type\\\\\\\": \\\\\\\"spinner\\\\\\\",\\\\n          \\\\\\\"meta_data\\\\\\\": {\\\\n            \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"concept\\\\\\\",\\\\n            \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"chw_referral_hf\\\\\\\",\\\\n            \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n          },\\\\n          \\\\\\\"properties\\\\\\\": {\\\\n            \\\\\\\"text\\\\\\\": \\\\\\\"Choose referral facility\\\\\\\",\\\\n            \\\\\\\"searchable\\\\\\\": \\\\\\\"Choose referral facility\\\\\\\"\\\\n          },\\\\n          \\\\\\\"options\\\\\\\": [],\\\\n          \\\\\\\"required_status\\\\\\\": \\\\\\\"yes:Please specify referral facility\\\\\\\"\\\\n        },\\\\n        {\\\\n          \\\\\\\"name\\\\\\\": \\\\\\\"referral_appointment_date\\\\\\\",\\\\n          \\\\\\\"type\\\\\\\": \\\\\\\"datetime_picker\\\\\\\",\\\\n          \\\\\\\"properties\\\\\\\": {\\\\n            \\\\\\\"hint\\\\\\\": \\\\\\\"Please select the appointment date\\\\\\\",\\\\n            \\\\\\\"type\\\\\\\": \\\\\\\"date_picker\\\\\\\",\\\\n            \\\\\\\"display_format\\\\\\\": \\\\\\\"dd/MM/yyyy\\\\\\\"\\\\n          },\\\\n          \\\\\\\"meta_data\\\\\\\": {\\\\n            \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"concept\\\\\\\",\\\\n            \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"referral_appointment_date\\\\\\\",\\\\n            \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\"\\\\n          },\\\\n          \\\\\\\"required_status\\\\\\\": \\\\\\\"true:Please specify the appointment date\\\\\\\"\\\\n        },\\\\n        {\\\\n          \\\\\\\"name\\\\\\\": \\\\\\\"referral_date\\\\\\\",\\\\n          \\\\\\\"meta_data\\\\\\\": {\\\\n            \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\",\\\\n            \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"concept\\\\\\\",\\\\n            \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"163181AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\\\"\\\\n          },\\\\n          \\\\\\\"type\\\\\\\": \\\\\\\"hidden\\\\\\\"\\\\n        },\\\\n        {\\\\n          \\\\\\\"name\\\\\\\": \\\\\\\"referral_time\\\\\\\",\\\\n          \\\\\\\"meta_data\\\\\\\": {\\\\n            \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\",\\\\n            \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"concept\\\\\\\",\\\\n            \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"referral_time\\\\\\\"\\\\n          },\\\\n          \\\\\\\"type\\\\\\\": \\\\\\\"hidden\\\\\\\"\\\\n        },\\\\n        {\\\\n          \\\\\\\"name\\\\\\\": \\\\\\\"referral_type\\\\\\\",\\\\n          \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\",\\\\n          \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"concept\\\\\\\",\\\\n          \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"referral_type\\\\\\\",\\\\n          \\\\\\\"type\\\\\\\": \\\\\\\"hidden\\\\\\\"\\\\n        },\\\\n        {\\\\n          \\\\\\\"name\\\\\\\": \\\\\\\"referral_status\\\\\\\",\\\\n          \\\\\\\"openmrs_entity_parent\\\\\\\": \\\\\\\"\\\\\\\",\\\\n          \\\\\\\"openmrs_entity\\\\\\\": \\\\\\\"concept\\\\\\\",\\\\n          \\\\\\\"openmrs_entity_id\\\\\\\": \\\\\\\"referral_status\\\\\\\",\\\\n          \\\\\\\"type\\\\\\\": \\\\\\\"hidden\\\\\\\"\\\\n        }\\\\n      ]\\\\n    }\\\\n  ]\\\\n}\\\"\",\"createdAt\":\"Apr 22, 2020, 7:00:40 PM\"},\"clientFormMetadata\":{\"id\":3,\"identifier\":\"referrals/anc_referral_form\",\"version\":\"0.0.2\",\"label\":\"ANC Referral form\",\"module\":\"ANC\",\"createdAt\":\"Apr 22, 2020, 7:00:40 PM\"}}";
        Mockito.when(httpAgent.fetch("http://opensrp_base_url/rest/clientForm?form_identifier=referrals/anc_referral_form&form_version=0.0.8")).thenReturn(
                new Response<String>(
                        success,
                        jsonObject));

        Mockito.doNothing().when(clientFormRepository).addOrUpdate(Mockito.any(ClientForm.class));

        documentConfigurationService.syncClientForms(activeManifest);
        Mockito.verify(clientFormRepository).addOrUpdate(Mockito.any(ClientForm.class));
    }

    @Test
    public void saveManifestVersionShouldSaveVersionInSharedPreferences() {

        Assert.assertNull(CoreLibrary.getInstance().context().allSharedPreferences().fetchManifestVersion());
        String manifestVersion = "0.0.89";

        documentConfigurationService.saveManifestVersion(manifestVersion);

        Assert.assertEquals(manifestVersion, CoreLibrary.getInstance().context().allSharedPreferences().fetchManifestVersion());
    }

    @After
    public void tearDown() {
        initCoreLibrary();
    }
}